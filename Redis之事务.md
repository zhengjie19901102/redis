## Redis中事务

`可以一次执行多个命令，本质是一组命令的集合。一个事务中的所有命令都会序列化，按顺序地串行化执行而不会被其它命令插入，不许加塞(中途数据变更等突发情况)。`

个人理解: redis中事务类似一个队列，且redis是部分支持事务(也就是没有像关系型数据库那样强制要求原子性[**即不保证原子性**])。

redis事务作用:**`一个队列中，一次性、顺序性、排他性的执行一系列命令。 `**

**重点**:`没有隔离级别的概念：队列中的命令没有提交之前都不会实际的被执行，因为事务提交前任何指令都不会被实际执行，也就不存在”事务内的查询要看到事务里的更新，在事务外查询不能看到”这个让人万分头痛的问题`

-- 以上均引自尚硅谷redis相关文档。

Redis事务相关的常用命令：

- WATCH 监视指定key，如果key值在exec之前数据不变则事务执行可以成功[是可以,如果事务中的命令有出现严重错误也可能会导致事务执行失败]。Watch指令，类似乐观锁，事务提交时，如果Key的值已被别的客户端改变，比如某个list已被别的客户端push/pop过了，整个事务队列都不会被执行。
  - 格式: `WATCH key值`。示例: `WATCH keyOne` 监视keyOne的数据变动。
- UNWATCH 取消监视所有key对应值得变化。
  - 格式: `UNWATCH`。示例: `UNWATCH` 取消监视所有key的监控。
- DISCARD 放弃要执行的事务[类似关系数据库的回滚事务]。
  - 格式: `DISCARD`。示例: `DISCARD` 之前的事务将放弃，事务块中的一系列动作全部取消。
- EXEC 执行事务，将事务块中的一些列命令执行。
  - 格式: `EXEC`。示例: `EXEC` 执行事务块中的命令，执行完毕后该事务结束。
- MULTI 开始事务块，之后的所有命令都将加入事务队列等待用户执行。
  - 格式: `MULTI`。示例: `MULTI` 之后的所有命令加入QUEUE[队列中]，当用户执行`EXEC`命令后整个事务提交。

Redis中的事务有四种表现形式:

1. 正常执行 。整个事务执行正常，全部命令都正常执行。
2. 放弃事务。当用户觉得此次事务不必要执行时通过`DISCARD`放弃本次事务的执行，这时事务块中的所有命令全部取消执行。
3. 全体执行成功或失败。类似于关系型数据库中的原子操作。只要一个命令执行失败，则全部失败。`注:因为redis是部分事务，所有只有当报出严重的错误时redis才认为是必须全部失败。`
4. 部分执行成功。这里才真正体现出redis的部分事务这个方面，当提交事务前redis并未报出语句的相关错误，则如果执行中发现错误那么有错误的会取消执行，而其他没有错误的则会正常执行成功。`redis中只有在执行事务前就出错的情况才会一直取消执行。`

#### 其他笔记

* 命令`DISCARD`必须在`MULTI`中的事事务块中执行，否则会报错: `ERR DISCARD without MULTI`。
* 在事务块之前执行`WATCH`命令之后，对于监视的key，只能本线程的事务中进行对应的更改，如果在执行事务之前的本线程外更改了该key，则本线程的事务块的命令执行失败，整个事务全部回滚。

